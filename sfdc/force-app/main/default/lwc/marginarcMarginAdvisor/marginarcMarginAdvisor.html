<template>
  <div class="marginarc-widget">
    <!-- Loading State -->
    <template lwc:if={isLoading}>
      <div class="marginarc-card">
        <div class="loading-state">
          <lightning-spinner
            alternative-text="Loading"
            size="medium"
          ></lightning-spinner>
          <p class="loading-text">Analyzing your deal...</p>
        </div>
      </div>
    </template>

    <!-- Error State -->
    <template lwc:if={error}>
      <div class="marginarc-card">
        <div class="error-state">
          <div class="error-icon">!</div>
          <p class="error-text">{error}</p>
        </div>
      </div>
    </template>

    <!-- Recommendation Display -->
    <template lwc:if={hasRecommendation}>
      <div class="marginarc-card">
        <!-- Phase 1: Score Hero + Compact Margin Bar Redesign -->
        <template lwc:if={isPhaseOne}>
          <!-- 1. Header — clean white background -->
          <div class="p1-header">
            <h3 class="p1-header-title">Margin Advisor</h3>
            <span class="p1-header-badge">{phase1BadgeText}<template
                lwc:if={isSegmentInferred}
              ><span class="p1-badge-estimated"> (est.)</span></template
            ></span>
          </div>

          <!-- 2. Score Hero — centerpiece -->
          <div class="p1-score-hero">
            <div class="p1-score-number" style={phase1ScoreStyle}>{phase1Score}</div>
            <div class="p1-gauge-container">
              <div class="p1-gauge-arc" style={phase1ScoreArcStyle}></div>
              <div class="p1-gauge-mask"></div>
            </div>
            <div class="p1-score-label" style={phase1ScoreLabelStyle}>{phase1ScoreLabel}</div>
            <template lwc:if={hasPhase1GpText}>
              <div class="p1-gp-opportunity">{phase1GpText}</div>
            </template>
          </div>

          <!-- 3. Compact Margin Range Bar -->
          <template lwc:if={isBenchmarkRecommendation}>
            <div class="p1-range-section">
              <div class="p1-range-bar-row">
                <span class="p1-range-endpoint">{marginRangeLow}%</span>
                <div class="p1-range-bar-track">
                  <div class="p1-range-bar-zone" style={benchmarkZoneStyle}></div>
                  <div class="p1-range-bar-median" style={benchmarkMedianBarStyle}></div>
                  <div class={plannedMarkerClass} style={plannedMarkerStyle}>
                    <div class="planned-marker-label">{currentMargin}%</div>
                  </div>
                </div>
                <span class="p1-range-endpoint">{marginRangeHigh}%</span>
              </div>
              <div class="p1-range-summary">
                <span class="p1-range-summary-text">{phase1PlanSummary} &middot; {phase1BenchmarkSummary}</span>
              </div>
            </div>
          </template>

          <!-- 4. Deal Insights — light background, max 2, filtered -->
          <template lwc:if={hasPhase1FilteredTips}>
            <div class="p1-insights">
              <template for:each={phase1FilteredTips} for:item="tip">
                <div key={tip.id} class="p1-insight-row">
                  <lightning-icon
                    icon-name={tip.icon}
                    size="x-small"
                  ></lightning-icon>
                  <span class="p1-insight-text">{tip.text}</span>
                </div>
              </template>
            </div>
          </template>

          <!-- Score Factor Labels (expanded only) -->
          <template lwc:if={isDetailExpanded}>
            <template lwc:if={hasDealScore}>
              <div class="score-factors p1-score-factors">
                <template for:each={dealScoreFactors} for:item="factor">
                  <div key={factor.name} class={factor.labelClass}>
                    {factor.label}
                  </div>
                </template>
              </div>
            </template>
            <template lwc:if={hasScoreImprovementTips}>
              <div class="score-tips">
                <p class="score-tips-header">Improve your score:</p>
                <template for:each={scoreImprovementTips} for:item="tip">
                  <div key={tip.text} class="score-tip-row">
                    <lightning-icon
                      icon-name={tip.icon}
                      size="xx-small"
                    ></lightning-icon>
                    <span class="score-tip-text">{tip.text}</span>
                    <span class="score-tip-pts">+{tip.pts} pts</span>
                  </div>
                </template>
              </div>
            </template>
          </template>
        </template>

        <!-- Deal Score Hero (Phase 2+) -->
        <template lwc:if={isNotPhaseOne}>
          <div class="deal-score-hero">
            <div class="score-header-row">
              <div class="score-title-group">
                <h3 class="score-main-title">Deal Score</h3>
                <span class="header-badge"
                  >{detectedOem} &bull; {detectedSegment}<template
                    lwc:if={isSegmentInferred}
                  >
                    <span class="segment-estimated">(estimated)</span></template
                  ></span
                >
                <template for:each={secondaryVendors} for:item="vendor">
                  <span key={vendor} class="marginarc-secondary-oem-badge"
                    >+{vendor}</span
                  >
                </template>
                <template lwc:if={hasOverflowVendors}>
                  <span
                    class="marginarc-secondary-oem-badge marginarc-overflow-badge"
                    >{overflowVendorLabel}</span
                  >
                </template>
              </div>
            </div>

            <div class="score-display">
              <div class="score-number" style={dealScoreStyle}>{dealScore}</div>
              <div class="score-label" style={dealScoreStyle}>
                {dealScoreLabel}
              </div>
            </div>

            <!-- Spectrum Bar -->
            <div class="score-spectrum-container">
              <div class="score-spectrum">
                <div class="score-marker" style={scoreMarkerStyle}>
                  <div class="score-marker-dot"></div>
                  <div class="score-marker-line"></div>
                </div>
              </div>
              <div class="score-spectrum-labels">
                <span class="spectrum-label spectrum-label-red">Needs Work</span>
                <span class="spectrum-label spectrum-label-orange"
                  >Below Avg</span
                >
                <span class="spectrum-label spectrum-label-yellow">Fair</span>
                <span class="spectrum-label spectrum-label-green">Good</span>
                <span class="spectrum-label spectrum-label-bright">Optimal</span>
              </div>
            </div>

            <!-- Score Factor Labels (expanded only) -->
            <template lwc:if={isDetailExpanded}>
              <template lwc:if={hasDealScore}>
                <div class="score-factors">
                  <template for:each={dealScoreFactors} for:item="factor">
                    <div key={factor.name} class={factor.labelClass}>
                      {factor.label}
                    </div>
                  </template>
                </div>
              </template>
              <template lwc:if={hasScoreImprovementTips}>
                <div class="score-tips">
                  <p class="score-tips-header">Improve your score:</p>
                  <template for:each={scoreImprovementTips} for:item="tip">
                    <div key={tip.text} class="score-tip-row">
                      <lightning-icon
                        icon-name={tip.icon}
                        size="xx-small"
                      ></lightning-icon>
                      <span class="score-tip-text">{tip.text}</span>
                      <span class="score-tip-pts">+{tip.pts} pts</span>
                    </div>
                  </template>
                </div>
              </template>
            </template>
          </div>
        </template>

        <!-- Score Summary Line (collapsed state compact info) -->
        <template lwc:if={isNotPhaseOne}>
          <div class="marginarc-score-summary">
            <span class="summary-score">Score: {dealScore}/100</span>
            <span class="summary-divider">|</span>
            <span class="summary-margin">Rec: {recommendedMargin}%</span>
            <span class="summary-divider">|</span>
            <span class="summary-confidence">{confidenceLabel}</span>
          </div>
        </template>

        <!-- Data Quality Indicators (expanded only) -->
        <template lwc:if={isDetailExpanded}>
          <template lwc:if={hasDataQuality}>
            <div class="marginarc-data-quality">
              <div class="marginarc-dq-header">
                <span class="marginarc-dq-title">Data Quality</span>
                <span class={dataQualityBadgeClass}>{dataQualityTier}</span>
              </div>
              <div class="marginarc-dq-bar-track">
                <div
                  class="marginarc-dq-bar-fill"
                  style={dataQualityBarStyle}
                ></div>
              </div>
              <div class="marginarc-dq-factors">
                <template for:each={dataQualityFactors} for:item="factor">
                  <span key={factor.name} class={factor.cssClass}>
                    <span class="marginarc-dq-icon">{factor.icon}</span>
                    {factor.name}
                  </span>
                </template>
              </div>
            </div>
          </template>
        </template>

        <!-- Phase 1 Callout — data foundation message (non-benchmark only) -->
        <template lwc:if={isPhaseOne}>
          <template lwc:if={isNotBenchmarkRecommendation}>
            <div class="marginarc-phase-callout">
              <div class="marginarc-phase-callout-icon">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <path
                    d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"
                  />
                </svg>
              </div>
              <div class="marginarc-phase-callout-body">
                <p class="marginarc-phase-callout-text">
                  {phaseCalloutMessage}
                </p>
                <template lwc:if={isNotPhaseThresholdMet}>
                  <div class="marginarc-phase-progress">
                    <div class="marginarc-phase-progress-track">
                      <div
                        class="marginarc-phase-progress-fill"
                        style={phaseProgressBarStyle}
                      ></div>
                    </div>
                    <span class="marginarc-phase-progress-label"
                      >{phaseProgressFraction}</span
                    >
                  </div>
                </template>
              </div>
            </div>
          </template>
        </template>

        <!-- Degradation Badge -->
        <template lwc:if={showDegradationBadge}>
          <div class="degradation-badge">
            <lightning-icon
              icon-name="utility:warning"
              size="xx-small"
              variant="warning"
            ></lightning-icon>
            <span class="degradation-text">{degradationMessage}</span>
          </div>
        </template>

        <!-- Recommended Margin Callout (Phase 2+) — ML 3-column or single -->
        <template lwc:if={showMLMarginOptions}>
          <div class="margin-options-grid">
            <div class="margin-option margin-option-conservative">
              <div class="margin-option-label">Conservative</div>
              <div class="margin-option-value">{conservativeMarginPct}%</div>
              <div class="margin-option-detail">Higher win probability</div>
            </div>
            <div class="margin-option margin-option-optimal">
              <div class="margin-option-badge">Best ROI</div>
              <div class="margin-option-label">Recommended</div>
              <div class="margin-option-value">{recommendedMargin}%</div>
              <div class="margin-option-detail">Max expected GP</div>
            </div>
            <div class="margin-option margin-option-aggressive">
              <div class="margin-option-label">Aggressive</div>
              <div class="margin-option-value">{aggressiveMarginPct}%</div>
              <div class="margin-option-detail">Higher margin</div>
            </div>
          </div>
        </template>
        <template lwc:if={showSingleMarginCallout}>
          <div class="rec-margin-callout">
            <div class="rec-margin-main">
              <span class="rec-margin-label">Recommended Margin</span>
              <span class="rec-margin-value">{recommendedMargin}%</span>
            </div>
            <div class="rec-margin-delta">
              <span class="rec-margin-current"
                >Your plan: {currentMargin}%</span
              >
              <span class={marginDeltaClass}>{marginDeltaDisplay}</span>
            </div>
          </div>
        </template>

        <!-- Phase 1 Footer: Refresh icon + Show Details -->
        <template lwc:if={isPhaseOne}>
          <div class="p1-footer">
            <button
              class="p1-footer-refresh"
              onclick={handleRefresh}
              aria-label="Refresh recommendation"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
            </button>
            <button
              class="p1-footer-details"
              onclick={toggleDetails}
              aria-expanded={isDetailExpanded}
              aria-label={detailsToggleLabel}
            >
              <span class="toggle-label">{detailsToggleLabel}</span>
              <span class="toggle-chevron">{detailsToggleIcon}</span>
            </button>
          </div>
        </template>

        <!-- Phase 2+ Action Bar -->
        <template lwc:if={isNotPhaseOne}>
          <div class="action-bar">
            <button
              class="btn-secondary"
              onclick={handleRefresh}
              aria-label="Refresh recommendation"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                />
              </svg>
              Refresh
            </button>
            <template lwc:if={showApplyButton}>
              <button
                class="btn-primary"
                onclick={handleCopyRecommendation}
                aria-label="Copy recommendation to clipboard"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
                  />
                </svg>
                Copy Recommendation
              </button>
              <button
                class="btn-text"
                onclick={handleApply}
                aria-label="Apply recommended margin to opportunity"
              >
                Apply to Opportunity
              </button>
            </template>
          </div>
        </template>

        <!-- Undo Bar (shown for 30s after applying) -->
        <template lwc:if={showUndoBar}>
          <div class="marginarc-undo-bar">
            <span class="undo-text">Recommendation applied.</span>
            <button class="btn-undo" onclick={handleUndo}>Undo</button>
            <span class="undo-timer">{undoCountdown}s</span>
          </div>
        </template>

        <!-- Show/Hide Details Toggle (Phase 2+ only — Phase 1 uses p1-footer) -->
        <template lwc:if={isNotPhaseOne}>
          <div class="details-toggle-bar">
            <button
              class="btn-toggle-details"
              onclick={toggleDetails}
              aria-expanded={isDetailExpanded}
              aria-label={detailsToggleLabel}
            >
              <span class="toggle-label">{detailsToggleLabel}</span>
              <span class="toggle-chevron">{detailsToggleIcon}</span>
            </button>
          </div>
        </template>

        <!-- Expandable Detail Sections -->
        <div class={detailsPanelClass}>
          <!-- Plan vs Recommendation Comparison (Phase 2+) -->
          <template lwc:if={showMarginRecommendation}>
            <div class="accordion-section">
              <div
                class="accordion-header"
                onclick={toggleComparison}
                role="button"
                tabindex="0"
                aria-expanded={isComparisonExpanded}
              >
                <span class="accordion-chevron">{comparisonChevron}</span>
                <span class="accordion-title">Plan vs Recommended</span>
              </div>
              <template lwc:if={isComparisonExpanded}>
                <div class="comparison-section">
                  <div class="comparison-header">
                    <div class="comparison-col-header"></div>
                    <div class="comparison-col-header comparison-col-planned">
                      Your Plan
                    </div>
                    <div
                      class="comparison-col-header comparison-col-recommended"
                    >
                      Recommended
                    </div>
                  </div>

                  <div class="comparison-row">
                    <div class="comparison-label">Margin</div>
                    <div class="comparison-value">{currentMargin}%</div>
                    <div class="comparison-value comparison-value-highlight">
                      {recommendedMargin}%
                    </div>
                  </div>

                  <div class="comparison-row">
                    <div class="comparison-label">Sell Price</div>
                    <div class="comparison-value">{dealContextSellPrice}</div>
                    <div class="comparison-value comparison-value-highlight">
                      {recommendedSellPrice}
                    </div>
                  </div>

                  <div class="comparison-row">
                    <div class="comparison-label">Gross Profit</div>
                    <div class="comparison-value">{dealContextGrossProfit}</div>
                    <div class="comparison-value comparison-value-highlight">
                      {recommendedGrossProfit}
                    </div>
                  </div>

                  <div class="comparison-row comparison-row-highlight">
                    <div class="comparison-label">Win Probability</div>
                    <div class="comparison-value">{plannedWinProbability}%</div>
                    <div class="comparison-value comparison-value-highlight">
                      {winProbability}%
                    </div>
                  </div>

                  <div class="comparison-row comparison-row-total">
                    <div class="comparison-label">Risk-Adj GP</div>
                    <div class="comparison-value">${plannedProfit}</div>
                    <div class="comparison-value comparison-value-highlight">
                      ${recommendedProfit}
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </template>

          <!-- ML Key Drivers (learned from org data) -->
          <template lwc:if={hasMLKeyDrivers}>
            <div class="ml-drivers-section">
              <div class="section-header">
                Key Drivers
                <span class="ml-badge">Learned from your data</span>
              </div>
              <template for:each={mlKeyDrivers} for:item="driver">
                <div key={driver.id} class="ml-driver-row">
                  <lightning-icon
                    icon-name={driver.iconName}
                    size="x-small"
                    class={driver.impactClass}
                  ></lightning-icon>
                  <span class="ml-driver-text">{driver.sentence}</span>
                  <span class={driver.impactClass}>{driver.impact}</span>
                </div>
              </template>
            </div>
          </template>

          <!-- Key Drivers (Phase 2+ — margin-specific) -->
          <template lwc:if={showMarginRecommendation}>
            <template lwc:if={hasDrivers}>
              <div class="accordion-section">
                <div
                  class="accordion-header"
                  onclick={toggleDrivers}
                  role="button"
                  tabindex="0"
                  aria-expanded={isDriversExpanded}
                >
                  <span class="accordion-chevron">{driversChevron}</span>
                  <span class="accordion-title"
                    >Key Drivers
                    <span class="accordion-count"
                      >{driverCount} factors</span
                    ></span
                  >
                </div>
                <template lwc:if={isDriversExpanded}>
                  <div class="drivers-section">
                    <div class="drivers-list">
                      <template for:each={topDrivers} for:item="driver">
                        <div key={driver.name} class="driver-row">
                          <span class="driver-name"> {driver.label} </span>
                          <div class="driver-bar-container">
                            <template lwc:if={driver.isPositive}>
                              <div
                                class="driver-bar driver-bar-positive"
                                style={driver.barStyle}
                              ></div>
                            </template>
                            <template lwc:if={driver.isNegative}>
                              <div
                                class="driver-bar driver-bar-negative"
                                style={driver.barStyle}
                              ></div>
                            </template>
                          </div>
                          <span class={driver.impactClass}
                            >{driver.impact}</span
                          >
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </template>

          <!-- AI Summary -->
          <template lwc:if={hasExplanation}>
            <div class="accordion-section">
              <div
                class="accordion-header"
                onclick={toggleAiSummary}
                role="button"
                tabindex="0"
                aria-expanded={isAiSummaryExpanded}
              >
                <span class="accordion-chevron">{aiSummaryChevron}</span>
                <span class="accordion-title">AI Analysis</span>
              </div>
              <template lwc:if={isAiSummaryExpanded}>
                <div class="ai-summary-section">
                  <p class="ai-summary-text">{aiExplanation}</p>
                  <template lwc:if={hasQualitativeSummary}>
                    <p class="ai-summary-qualitative">{qualitativeSummary}</p>
                  </template>
                </div>
              </template>
            </div>
          </template>

          <!-- Recommendation History (Phase 2+ only — Fix 3) -->
          <template lwc:if={isNotPhaseOne}>
            <template lwc:if={hasHistory}>
              <div class="history-section">
                <div
                  class="history-header"
                  onclick={toggleHistory}
                  role="button"
                  tabindex="0"
                  aria-expanded={showHistory}
                >
                  <span class="history-chevron">{historyChevron}</span>
                  <span class="history-title">Recommendation History</span>
                  <span class="history-count">{historyItems.length}</span>
                </div>
                <template lwc:if={showHistory}>
                  <div class="history-timeline">
                    <template for:each={historyItems} for:item="item">
                      <div class="history-item" key={item.id}>
                        <div class="hist-date-col">
                          <div class="hist-date">{item.dateStr}</div>
                          <div class="hist-time">{item.timeStr}</div>
                        </div>
                        <div class="hist-dot"></div>
                        <div class="hist-content">
                          <div class="hist-top-row">
                            <span class={item.sourceClass}>{item.source}</span>
                            <span class={item.appliedClass}
                              >{item.appliedLabel}</span
                            >
                          </div>
                          <div class="hist-metrics">
                            <div class="hist-metric">
                              <span class="hist-metric-label">Rec</span>
                              <span class="hist-metric-value"
                                >{item.margin}</span
                              >
                            </div>
                            <div class="hist-metric">
                              <span class="hist-metric-label">Plan</span>
                              <span class="hist-metric-value"
                                >{item.planned}</span
                              >
                            </div>
                            <div class="hist-metric">
                              <span class="hist-metric-label">Gap</span>
                              <span class={item.gapClass}>{item.gapStr}</span>
                            </div>
                            <div class="hist-metric">
                              <span class="hist-metric-label">Conf</span>
                              <span class="hist-metric-value"
                                >{item.confidence}</span
                              >
                            </div>
                            <div class="hist-metric">
                              <span class="hist-metric-label">Win%</span>
                              <span class="hist-metric-value"
                                >{item.winProb}</span
                              >
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </template>
          </template>

          <!-- BOM Summary (full BOM editing in standalone BOM Builder widget) -->
          <template lwc:if={hasBomSummary}>
            <div class="accordion-section">
              <div
                class="accordion-header"
                onclick={toggleBomSummary}
                role="button"
                tabindex="0"
                aria-expanded={isBomSummaryExpanded}
              >
                <span class="accordion-chevron">{bomSummaryChevron}</span>
                <span class="accordion-title"
                  >Bill of Materials
                  <span class="accordion-count"
                    >{bomLineCount} lines</span
                  ></span
                >
              </div>
              <template lwc:if={isBomSummaryExpanded}>
                <div class="bom-summary-section">
                  <div class="bom-summary-stats">
                    <div class="bom-stat">
                      <span class="bom-stat-label">Total Cost</span>
                      <span class="bom-stat-value">{bomTotalCost}</span>
                    </div>
                    <div class="bom-stat">
                      <span class="bom-stat-label">Total Price</span>
                      <span class="bom-stat-value">{bomTotalPrice}</span>
                    </div>
                    <div class="bom-stat">
                      <span class="bom-stat-label">Blended Margin</span>
                      <span class="bom-stat-value">{bomBlendedMargin}</span>
                    </div>
                  </div>
                  <!-- BOM/Opportunity Amount mismatch warning -->
                  <template lwc:if={bomOppAmountMismatch}>
                    <div class="bom-mismatch-warning">
                      <lightning-icon
                        icon-name="utility:warning"
                        size="x-small"
                        variant="warning"
                      ></lightning-icon>
                      <span
                        >BOM total ({bomOppAmountMismatch.bomTotal}) differs
                        from Opportunity Amount
                        ({bomOppAmountMismatch.oppAmount}) by
                        {bomOppAmountMismatch.delta}
                        ({bomOppAmountMismatch.pctDiff}%)</span
                      >
                    </div>
                  </template>
                  <!-- Phase 3: Per-line BOM margin recommendations -->
                  <template lwc:if={hasBomLineRecommendations}>
                    <div class="marginarc-bom-lines">
                      <div class="marginarc-bom-lines-header">
                        <span class="marginarc-bom-lines-col">Line Item</span>
                        <span class="marginarc-bom-lines-col">Current</span>
                        <template lwc:if={showBomRecColumn}>
                          <span class="marginarc-bom-lines-col"
                            >Recommended</span
                          >
                        </template>
                        <span class="marginarc-bom-lines-col">Gap</span>
                      </div>
                      <template for:each={bomLineItems} for:item="line">
                        <div class="marginarc-bom-line-row" key={line.key}>
                          <span
                            class="marginarc-bom-line-label"
                            title={line.label}
                          >
                            <span class="marginarc-bom-line-cat"
                              >{line.category}</span
                            >
                            {line.label}
                          </span>
                          <span class="marginarc-bom-line-value"
                            >{line.currentMarginDisplay}</span
                          >
                          <template lwc:if={showBomRecColumn}>
                            <span
                              class="marginarc-bom-line-value marginarc-bom-line-rec"
                              >{line.recommendedMarginDisplay}</span
                            >
                          </template>
                          <span class={line.gapClass}>{line.gapDisplay}</span>
                        </div>
                      </template>
                    </div>
                  </template>

                  <!-- Phase 3: Optimize BOM Margins button -->
                  <template lwc:if={showBomOptimizeButton}>
                    <button
                      class="btn-bom-optimize"
                      onclick={handleOptimizeBom}
                      disabled={isBomOptimizing}
                      aria-label="Optimize BOM margins with AI"
                    >
                      <template lwc:if={isBomOptimizing}>
                        <lightning-spinner
                          alternative-text="Optimizing"
                          size="xx-small"
                        ></lightning-spinner>
                        Optimizing...
                      </template>
                      <template lwc:else>
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Optimize BOM Margins
                      </template>
                    </button>
                  </template>

                  <p class="bom-summary-hint">
                    Use the BOM Builder widget on this page to edit line items
                    and analyze margins.
                  </p>
                </div>
              </template>
            </div>
          </template>

          <!-- Model Transparency -->
          <template lwc:if={hasModelMetrics}>
            <div class="model-transparency">
              <lightning-icon
                icon-name="utility:info"
                size="xx-small"
              ></lightning-icon>
              <span class="model-transparency-text">{modelMetricsDisplay}</span>
            </div>
          </template>

          <!-- Collapse All link -->
          <div class="collapse-all-bar">
            <button
              class="btn-collapse-all"
              onclick={collapseAll}
              aria-label="Collapse all detail sections"
            >
              Collapse All
            </button>
          </div>
        </div>
        <!-- /marginarc-details-panel -->
      </div>
    </template>
  </div>

  <!-- Confirmation Dialog -->
  <template lwc:if={showConfirmDialog}>
    <div
      class="confirm-overlay"
      onclick={handleCancelApply}
      onkeydown={handleConfirmKeydown}
    >
      <div
        class="confirm-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="confirm-dialog-title"
        onclick={stopPropagation}
      >
        <div class="confirm-header" id="confirm-dialog-title">
          Confirm Apply Recommendation
        </div>
        <div class="confirm-body">
          <p>This will update:</p>
          <div class="confirm-comparison-table">
            <div class="confirm-table-header">
              <span class="confirm-table-col confirm-table-col-field"
                >Field</span
              >
              <span class="confirm-table-col confirm-table-col-current"
                >Current</span
              >
              <span class="confirm-table-col confirm-table-col-new">New</span>
            </div>
            <div class="confirm-table-row">
              <span class="confirm-table-col confirm-table-col-field"
                >Amount</span
              >
              <span class="confirm-table-col confirm-table-col-current"
                >{confirmCurrentAmount}</span
              >
              <span class="confirm-table-col confirm-table-col-new"
                >{confirmNewAmount}</span
              >
            </div>
            <div class="confirm-table-row">
              <span class="confirm-table-col confirm-table-col-field"
                >Planned Margin</span
              >
              <span class="confirm-table-col confirm-table-col-current"
                >{confirmCurrentPlannedMargin}%</span
              >
              <span class="confirm-table-col confirm-table-col-new"
                >{confirmMarginPct}%</span
              >
            </div>
            <div class="confirm-table-row">
              <span class="confirm-table-col confirm-table-col-field"
                >Win Probability</span
              >
              <span class="confirm-table-col confirm-table-col-current"
                >{confirmCurrentWinProb}%</span
              >
              <span class="confirm-table-col confirm-table-col-new"
                >{confirmWinProb}%</span
              >
            </div>
          </div>
          <template lwc:if={confirmHasBom}>
            <p class="confirm-bom-info">
              {confirmBomLineCount} BOM line items will also be saved to this
              Opportunity.
            </p>
          </template>
          <p class="confirm-info">
            You can undo this change for 30 seconds after applying.
          </p>
        </div>
        <div class="confirm-footer">
          <button class="btn-secondary" onclick={handleCancelApply}>
            Cancel
          </button>
          <button class="btn-primary" onclick={handleConfirmApply}>
            Apply
          </button>
        </div>
      </div>
    </div>
  </template>
</template>
