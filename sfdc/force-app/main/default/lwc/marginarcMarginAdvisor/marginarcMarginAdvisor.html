<template>
  <div class="marginarc-widget">
    <!-- Loading State -->
    <template lwc:if={isLoading}>
      <div class="marginarc-card">
        <div class="loading-state">
          <lightning-spinner
            alternative-text="Loading"
            size="medium"
          ></lightning-spinner>
          <p class="loading-text">Analyzing your deal...</p>
        </div>
      </div>
    </template>

    <!-- Error State -->
    <template lwc:if={error}>
      <div class="marginarc-card">
        <div class="error-state">
          <div class="error-icon">!</div>
          <p class="error-text">{error}</p>
        </div>
      </div>
    </template>

    <!-- Recommendation Display -->
    <template lwc:if={hasRecommendation}>
      <div class="marginarc-card">
        <!-- Deal Score Hero -->
        <div class="deal-score-hero">
          <div class="score-header-row">
            <div class="score-title-group">
              <h3 class="score-main-title">Deal Score</h3>
              <span class="header-badge"
                >{detectedOem} &bull; {detectedSegment}<template
                  lwc:if={isSegmentInferred}
                >
                  <span class="segment-estimated">(estimated)</span></template
                ></span
              >
              <template for:each={secondaryVendors} for:item="vendor">
                <span key={vendor} class="marginarc-secondary-oem-badge"
                  >+{vendor}</span
                >
              </template>
              <template lwc:if={hasOverflowVendors}>
                <span
                  class="marginarc-secondary-oem-badge marginarc-overflow-badge"
                  >{overflowVendorLabel}</span
                >
              </template>
            </div>
          </div>

          <div class="score-display">
            <div class="score-number" style={dealScoreStyle}>{dealScore}</div>
            <div class="score-label" style={dealScoreStyle}>
              {dealScoreLabel}
            </div>
          </div>

          <!-- Spectrum Bar -->
          <div class="score-spectrum-container">
            <div class="score-spectrum">
              <div class="score-marker" style={scoreMarkerStyle}>
                <div class="score-marker-dot"></div>
                <div class="score-marker-line"></div>
              </div>
            </div>
            <div class="score-spectrum-labels">
              <span class="spectrum-label spectrum-label-red">Needs Work</span>
              <span class="spectrum-label spectrum-label-orange"
                >Below Avg</span
              >
              <span class="spectrum-label spectrum-label-yellow">Fair</span>
              <span class="spectrum-label spectrum-label-green">Good</span>
              <span class="spectrum-label spectrum-label-bright">Optimal</span>
            </div>
          </div>

          <!-- Phase 1 Deal Insights -->
          <template lwc:if={hasPhase1Tips}>
            <div class="marginarc-phase1-insights">
              <h3 class="insights-header">Deal Insights</h3>
              <template for:each={phase1Tips} for:item="tip">
                <div key={tip.id} class="insight-row">
                  <lightning-icon
                    icon-name={tip.icon}
                    size="x-small"
                  ></lightning-icon>
                  <span class="insight-text">{tip.text}</span>
                </div>
              </template>
            </div>
          </template>

          <!-- Score Factor Labels (expanded only) -->
          <template lwc:if={isDetailExpanded}>
            <template lwc:if={hasDealScore}>
              <div class="score-factors">
                <template for:each={dealScoreFactors} for:item="factor">
                  <div key={factor.name} class={factor.labelClass}>
                    {factor.label}
                  </div>
                </template>
              </div>
            </template>
          </template>
        </div>

        <!-- Score Summary Line (collapsed state compact info) -->
        <div class="marginarc-score-summary">
          <span class="summary-score">Score: {dealScore}/100</span>
          <span class="summary-divider">|</span>
          <template lwc:if={isPhaseOne}>
            <span class="summary-label">{dealScoreLabel}</span>
            <template lwc:if={hasDataQuality}>
              <span class="summary-divider">|</span>
              <span class="summary-dq">{dataQualityTier}</span>
            </template>
          </template>
          <template lwc:if={isNotPhaseOne}>
            <span class="summary-margin">Rec: {recommendedMargin}%</span>
            <span class="summary-divider">|</span>
            <span class="summary-confidence">{confidenceLabel}</span>
          </template>
        </div>

        <!-- Data Quality Indicators (expanded only) -->
        <template lwc:if={isDetailExpanded}>
          <template lwc:if={hasDataQuality}>
            <div class="marginarc-data-quality">
              <div class="marginarc-dq-header">
                <span class="marginarc-dq-title">Data Quality</span>
                <span class={dataQualityBadgeClass}>{dataQualityTier}</span>
              </div>
              <div class="marginarc-dq-bar-track">
                <div
                  class="marginarc-dq-bar-fill"
                  style={dataQualityBarStyle}
                ></div>
              </div>
              <div class="marginarc-dq-factors">
                <template for:each={dataQualityFactors} for:item="factor">
                  <span key={factor.name} class={factor.cssClass}>
                    <span class="marginarc-dq-icon">{factor.icon}</span>
                    {factor.name}
                  </span>
                </template>
              </div>
            </div>
          </template>
        </template>

        <!-- Phase 1 Callout — data foundation message -->
        <template lwc:if={isPhaseOne}>
          <div class="marginarc-phase-callout">
            <div class="marginarc-phase-callout-icon">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path
                  d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"
                />
              </svg>
            </div>
            <div class="marginarc-phase-callout-body">
              <p class="marginarc-phase-callout-text">{phaseCalloutMessage}</p>
              <template lwc:if={isNotPhaseThresholdMet}>
                <div class="marginarc-phase-progress">
                  <div class="marginarc-phase-progress-track">
                    <div
                      class="marginarc-phase-progress-fill"
                      style={phaseProgressBarStyle}
                    ></div>
                  </div>
                  <span class="marginarc-phase-progress-label"
                    >{phaseProgressFraction}</span
                  >
                </div>
              </template>
            </div>
          </div>
        </template>

        <!-- Degradation Badge -->
        <template lwc:if={showDegradationBadge}>
          <div class="degradation-badge">
            <lightning-icon
              icon-name="utility:warning"
              size="xx-small"
              variant="warning"
            ></lightning-icon>
            <span class="degradation-text">{degradationMessage}</span>
          </div>
        </template>

        <!-- Recommended Margin Callout (Phase 2+) -->
        <template lwc:if={showMarginRecommendation}>
          <div class="rec-margin-callout">
            <div class="rec-margin-main">
              <span class="rec-margin-label">Recommended Margin</span>
              <span class="rec-margin-value">{recommendedMargin}%</span>
            </div>
            <div class="rec-margin-delta">
              <span class="rec-margin-current"
                >Your plan: {currentMargin}%</span
              >
              <span class={marginDeltaClass}>{marginDeltaDisplay}</span>
            </div>
          </div>
        </template>

        <!-- Action Bar (above the fold) -->
        <div class="action-bar">
          <button
            class="btn-secondary"
            onclick={handleRefresh}
            aria-label="Refresh recommendation"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
            Refresh
          </button>
          <template lwc:if={showApplyButton}>
            <button
              class="btn-primary"
              onclick={handleCopyRecommendation}
              aria-label="Copy recommendation to clipboard"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"
                />
              </svg>
              Copy Recommendation
            </button>
            <button
              class="btn-text"
              onclick={handleApply}
              aria-label="Apply recommended margin to opportunity"
            >
              Apply to Opportunity
            </button>
          </template>
        </div>

        <!-- Undo Bar (shown for 30s after applying) -->
        <template lwc:if={showUndoBar}>
          <div class="marginarc-undo-bar">
            <span class="undo-text">Recommendation applied.</span>
            <button class="btn-undo" onclick={handleUndo}>Undo</button>
            <span class="undo-timer">{undoCountdown}s</span>
          </div>
        </template>

        <!-- Show/Hide Details Toggle -->
        <div class="details-toggle-bar">
          <button
            class="btn-toggle-details"
            onclick={toggleDetails}
            aria-expanded={isDetailExpanded}
            aria-label={detailsToggleLabel}
          >
            <span class="toggle-label">{detailsToggleLabel}</span>
            <span class="toggle-chevron">{detailsToggleIcon}</span>
          </button>
        </div>

        <!-- Expandable Detail Sections -->
        <div class={detailsPanelClass}>
          <!-- Plan vs Recommendation Comparison (Phase 2+) -->
          <template lwc:if={showMarginRecommendation}>
            <div class="accordion-section">
              <div
                class="accordion-header"
                onclick={toggleComparison}
                role="button"
                tabindex="0"
                aria-expanded={isComparisonExpanded}
              >
                <span class="accordion-chevron">{comparisonChevron}</span>
                <span class="accordion-title">Plan vs Recommended</span>
              </div>
              <template lwc:if={isComparisonExpanded}>
                <div class="comparison-section">
                  <div class="comparison-header">
                    <div class="comparison-col-header"></div>
                    <div class="comparison-col-header comparison-col-planned">
                      Your Plan
                    </div>
                    <div
                      class="comparison-col-header comparison-col-recommended"
                    >
                      Recommended
                    </div>
                  </div>

                  <div class="comparison-row">
                    <div class="comparison-label">Margin</div>
                    <div class="comparison-value">{currentMargin}%</div>
                    <div class="comparison-value comparison-value-highlight">
                      {recommendedMargin}%
                    </div>
                  </div>

                  <div class="comparison-row">
                    <div class="comparison-label">Sell Price</div>
                    <div class="comparison-value">{dealContextSellPrice}</div>
                    <div class="comparison-value comparison-value-highlight">
                      {recommendedSellPrice}
                    </div>
                  </div>

                  <div class="comparison-row">
                    <div class="comparison-label">Gross Profit</div>
                    <div class="comparison-value">{dealContextGrossProfit}</div>
                    <div class="comparison-value comparison-value-highlight">
                      {recommendedGrossProfit}
                    </div>
                  </div>

                  <div class="comparison-row comparison-row-highlight">
                    <div class="comparison-label">Win Probability</div>
                    <div class="comparison-value">{plannedWinProbability}%</div>
                    <div class="comparison-value comparison-value-highlight">
                      {winProbability}%
                    </div>
                  </div>

                  <div class="comparison-row comparison-row-total">
                    <div class="comparison-label">Risk-Adj GP</div>
                    <div class="comparison-value">${plannedProfit}</div>
                    <div class="comparison-value comparison-value-highlight">
                      ${recommendedProfit}
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </template>

          <!-- Key Drivers (Phase 2+ — margin-specific) -->
          <template lwc:if={showMarginRecommendation}>
            <template lwc:if={hasDrivers}>
              <div class="accordion-section">
                <div
                  class="accordion-header"
                  onclick={toggleDrivers}
                  role="button"
                  tabindex="0"
                  aria-expanded={isDriversExpanded}
                >
                  <span class="accordion-chevron">{driversChevron}</span>
                  <span class="accordion-title"
                    >Key Drivers
                    <span class="accordion-count"
                      >{driverCount} factors</span
                    ></span
                  >
                </div>
                <template lwc:if={isDriversExpanded}>
                  <div class="drivers-section">
                    <div class="drivers-list">
                      <template for:each={topDrivers} for:item="driver">
                        <div key={driver.name} class="driver-row">
                          <span class="driver-name"> {driver.label} </span>
                          <div class="driver-bar-container">
                            <template lwc:if={driver.isPositive}>
                              <div
                                class="driver-bar driver-bar-positive"
                                style={driver.barStyle}
                              ></div>
                            </template>
                            <template lwc:if={driver.isNegative}>
                              <div
                                class="driver-bar driver-bar-negative"
                                style={driver.barStyle}
                              ></div>
                            </template>
                          </div>
                          <span class={driver.impactClass}
                            >{driver.impact}</span
                          >
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </template>

          <!-- AI Summary -->
          <template lwc:if={hasExplanation}>
            <div class="accordion-section">
              <div
                class="accordion-header"
                onclick={toggleAiSummary}
                role="button"
                tabindex="0"
                aria-expanded={isAiSummaryExpanded}
              >
                <span class="accordion-chevron">{aiSummaryChevron}</span>
                <span class="accordion-title">AI Analysis</span>
              </div>
              <template lwc:if={isAiSummaryExpanded}>
                <div class="ai-summary-section">
                  <p class="ai-summary-text">{aiExplanation}</p>
                  <template lwc:if={hasQualitativeSummary}>
                    <p class="ai-summary-qualitative">{qualitativeSummary}</p>
                  </template>
                </div>
              </template>
            </div>
          </template>

          <!-- Recommendation History (Phase 2+ only — Fix 3) -->
          <template lwc:if={isNotPhaseOne}>
            <template lwc:if={hasHistory}>
              <div class="history-section">
                <div
                  class="history-header"
                  onclick={toggleHistory}
                  role="button"
                  tabindex="0"
                  aria-expanded={showHistory}
                >
                  <span class="history-chevron">{historyChevron}</span>
                  <span class="history-title">Recommendation History</span>
                  <span class="history-count">{historyItems.length}</span>
                </div>
                <template lwc:if={showHistory}>
                  <div class="history-timeline">
                    <template for:each={historyItems} for:item="item">
                      <div class="history-item" key={item.id}>
                        <div class="hist-date-col">
                          <div class="hist-date">{item.dateStr}</div>
                          <div class="hist-time">{item.timeStr}</div>
                        </div>
                        <div class="hist-dot"></div>
                        <div class="hist-content">
                          <div class="hist-top-row">
                            <span class={item.sourceClass}>{item.source}</span>
                            <span class={item.appliedClass}
                              >{item.appliedLabel}</span
                            >
                          </div>
                          <div class="hist-metrics">
                            <div class="hist-metric">
                              <span class="hist-metric-label">Rec</span>
                              <span class="hist-metric-value"
                                >{item.margin}</span
                              >
                            </div>
                            <div class="hist-metric">
                              <span class="hist-metric-label">Plan</span>
                              <span class="hist-metric-value"
                                >{item.planned}</span
                              >
                            </div>
                            <div class="hist-metric">
                              <span class="hist-metric-label">Gap</span>
                              <span class={item.gapClass}>{item.gapStr}</span>
                            </div>
                            <div class="hist-metric">
                              <span class="hist-metric-label">Conf</span>
                              <span class="hist-metric-value"
                                >{item.confidence}</span
                              >
                            </div>
                            <div class="hist-metric">
                              <span class="hist-metric-label">Win%</span>
                              <span class="hist-metric-value"
                                >{item.winProb}</span
                              >
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>
              </div>
            </template>
          </template>

          <!-- BOM Summary (full BOM editing in standalone BOM Builder widget) -->
          <template lwc:if={hasBomSummary}>
            <div class="accordion-section">
              <div
                class="accordion-header"
                onclick={toggleBomSummary}
                role="button"
                tabindex="0"
                aria-expanded={isBomSummaryExpanded}
              >
                <span class="accordion-chevron">{bomSummaryChevron}</span>
                <span class="accordion-title"
                  >Bill of Materials
                  <span class="accordion-count"
                    >{bomLineCount} lines</span
                  ></span
                >
              </div>
              <template lwc:if={isBomSummaryExpanded}>
                <div class="bom-summary-section">
                  <div class="bom-summary-stats">
                    <div class="bom-stat">
                      <span class="bom-stat-label">Total Cost</span>
                      <span class="bom-stat-value">{bomTotalCost}</span>
                    </div>
                    <div class="bom-stat">
                      <span class="bom-stat-label">Total Price</span>
                      <span class="bom-stat-value">{bomTotalPrice}</span>
                    </div>
                    <div class="bom-stat">
                      <span class="bom-stat-label">Blended Margin</span>
                      <span class="bom-stat-value">{bomBlendedMargin}</span>
                    </div>
                  </div>
                  <!-- Phase 3: Per-line BOM margin recommendations -->
                  <template lwc:if={hasBomLineRecommendations}>
                    <div class="marginarc-bom-lines">
                      <div class="marginarc-bom-lines-header">
                        <span class="marginarc-bom-lines-col">Line Item</span>
                        <span class="marginarc-bom-lines-col">Current</span>
                        <span class="marginarc-bom-lines-col">Recommended</span>
                        <span class="marginarc-bom-lines-col">Gap</span>
                      </div>
                      <template for:each={bomLineItems} for:item="line">
                        <div class="marginarc-bom-line-row" key={line.key}>
                          <span
                            class="marginarc-bom-line-label"
                            title={line.label}
                          >
                            <span class="marginarc-bom-line-cat"
                              >{line.category}</span
                            >
                            {line.label}
                          </span>
                          <span class="marginarc-bom-line-value"
                            >{line.currentMarginDisplay}</span
                          >
                          <span
                            class="marginarc-bom-line-value marginarc-bom-line-rec"
                            >{line.recommendedMarginDisplay}</span
                          >
                          <span class={line.gapClass}>{line.gapDisplay}</span>
                        </div>
                      </template>
                    </div>
                  </template>

                  <!-- Phase 3: Optimize BOM Margins button -->
                  <template lwc:if={showBomOptimizeButton}>
                    <button
                      class="btn-bom-optimize"
                      onclick={handleOptimizeBom}
                      disabled={isBomOptimizing}
                      aria-label="Optimize BOM margins with AI"
                    >
                      <template lwc:if={isBomOptimizing}>
                        <lightning-spinner
                          alternative-text="Optimizing"
                          size="xx-small"
                        ></lightning-spinner>
                        Optimizing...
                      </template>
                      <template lwc:else>
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Optimize BOM Margins
                      </template>
                    </button>
                  </template>

                  <p class="bom-summary-hint">
                    Use the BOM Builder widget on this page to edit line items
                    and analyze margins.
                  </p>
                </div>
              </template>
            </div>
          </template>

          <!-- Collapse All link -->
          <div class="collapse-all-bar">
            <button
              class="btn-collapse-all"
              onclick={collapseAll}
              aria-label="Collapse all detail sections"
            >
              Collapse All
            </button>
          </div>
        </div>
        <!-- /marginarc-details-panel -->
      </div>
    </template>
  </div>

  <!-- Confirmation Dialog -->
  <template lwc:if={showConfirmDialog}>
    <div
      class="confirm-overlay"
      onclick={handleCancelApply}
      onkeydown={handleConfirmKeydown}
    >
      <div
        class="confirm-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="confirm-dialog-title"
        onclick={stopPropagation}
      >
        <div class="confirm-header" id="confirm-dialog-title">
          Confirm Apply Recommendation
        </div>
        <div class="confirm-body">
          <p>This will update:</p>
          <div class="confirm-comparison-table">
            <div class="confirm-table-header">
              <span class="confirm-table-col confirm-table-col-field"
                >Field</span
              >
              <span class="confirm-table-col confirm-table-col-current"
                >Current</span
              >
              <span class="confirm-table-col confirm-table-col-new">New</span>
            </div>
            <div class="confirm-table-row">
              <span class="confirm-table-col confirm-table-col-field"
                >Amount</span
              >
              <span class="confirm-table-col confirm-table-col-current"
                >{confirmCurrentAmount}</span
              >
              <span class="confirm-table-col confirm-table-col-new"
                >{confirmNewAmount}</span
              >
            </div>
            <div class="confirm-table-row">
              <span class="confirm-table-col confirm-table-col-field"
                >Planned Margin</span
              >
              <span class="confirm-table-col confirm-table-col-current"
                >{confirmCurrentPlannedMargin}%</span
              >
              <span class="confirm-table-col confirm-table-col-new"
                >{confirmMarginPct}%</span
              >
            </div>
            <div class="confirm-table-row">
              <span class="confirm-table-col confirm-table-col-field"
                >Win Probability</span
              >
              <span class="confirm-table-col confirm-table-col-current"
                >{confirmCurrentWinProb}%</span
              >
              <span class="confirm-table-col confirm-table-col-new"
                >{confirmWinProb}%</span
              >
            </div>
          </div>
          <template lwc:if={confirmHasBom}>
            <p class="confirm-bom-info">
              {confirmBomLineCount} BOM line items will also be saved to this
              Opportunity.
            </p>
          </template>
          <p class="confirm-info">
            You can undo this change for 30 seconds after applying.
          </p>
        </div>
        <div class="confirm-footer">
          <button class="btn-secondary" onclick={handleCancelApply}>
            Cancel
          </button>
          <button class="btn-primary" onclick={handleConfirmApply}>
            Apply
          </button>
        </div>
      </div>
    </div>
  </template>
</template>
